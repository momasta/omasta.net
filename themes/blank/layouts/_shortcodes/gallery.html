{{- /*
    Stylesheet: assets/sass/components/_gallery.scss
    
    See README.md#image-gallery
    
    Based on https://codeproject.com/Articles/5276331/Creating-an-Image-Gallery-with-Hugo-and-Lightbox2
*/ -}}

{{- $dateFormat := .Site.Params.dateFormat -}}

{{- /* Argument: Image Source (subdir of assets/images) (Optional) */ -}}
{{- $param0 := default "" (.Get 0) -}}
{{- $directory := cond (ne "" $param0) (print "/" $param0) "" -}}
{{- $path := (print "images" $directory "/*.{jpg,JPG,jpeg,JPEG,png,PNG,gif,GIF}") -}}

{{- /* Argument: Class (Optional) */ -}}
{{- $class := default "" (.Get 1) -}}

{{- /* Argument: Sort By (Optional) */ -}}
{{- $sortBy := default "date" (.Get 2) -}}

{{- /* Handle sizing */ -}}
{{- $size := "m" -}}
{{- $thumbSize1x := 150 -}}
{{- if strings.Contains $class "size-s" -}}
    {{- $size = "s" -}}
    {{- $thumbSize1x = 59 -}}
{{- end -}}
{{- $thumbSize2x := (mul $thumbSize1x 2) -}}

{{- /* Gallery Filter, for sizes M and up */ -}}
{{- if ne $size "s" -}}
    <div class="gallery-filter">
        <form action="#" class="gallery-filter-form">
            <label for="gallery-search" class="visually-hidden">
                {{- T "search-memes" -}}
            </label>
            <input type="search"
                   id="gallery-search"
                   name="q"
                   placeholder="{{ T "search" }}"
                   class="gallery-filter-input"
                   autocomplete="on"
                   autocapitalize="off"
                   autofocus
                   title="{{ printf "– %s\n– %s" (T "press-esc") (T "press-stroke") }}" 
                   aria-label="{{ T "search-memes" }}">
    
            <input type="submit"
                   value="{{ T "search" }}"
                   class="visually-hidden">
        </form>
    </div>
    
    {{- /* No Results Message */ -}}
    <p id="gallery-no-results" aria-hidden="true" class="state-hidden">
        {{- T "no-images-found" -}}
    </p>
{{- end -}}

{{- /* Gallery */ -}}
<div class="gallery{{ with $class }} {{ . }}{{ end }}">
    {{- $images := resources.Match $path }}

    {{- if $images }}
        {{- $imagesSlice := slice -}}

        {{- range $image := $images -}}
            {{- $filePath := printf "assets/%s" $image.Name }}
            {{- $fileInfo := os.Stat $filePath }}
            {{- $imagesSlice = $imagesSlice | append (dict "modTime" $fileInfo.ModTime "image" $image) }}
        {{- end -}}

        {{- /* Sort images, default: by date */ -}}
        {{- $sorted := cond (eq $sortBy "name") $imagesSlice (sort $imagesSlice "modTime" "desc") -}}

        {{- /* Loop all images */ -}}
        {{- range $index, $item := $sorted -}}
            {{- $image := $item.image -}}
            {{- $imageName := ($image.Name | replaceRE "^.*/(.*)\\..*" "$1") | safeHTMLAttr -}}
            {{- $imageURL := $image.RelPermalink | safeURL -}}
            {{- $imageDate := $item.modTime.Format $dateFormat | safeHTML -}}
            {{- $imageDateText := printf "\n\n%s %s" (T "last-mod-short") $imageDate -}}
            {{- $imageID := $imageName |
                            replaceRE "['’~#_+./@]" "" |
                            urlize |
                            replaceRE "-{2,}" "-" -}}

            <a href="{{- $imageURL }}"
               class="gallery-image"
               data-pswp-width="{{ $image.Width }}"
               data-pswp-height="{{ $image.Height }}"
               data-cropped="true"
               id="{{ $imageID }}"
               target="_blank"
               title="{{ $imageName }}{{ $imageDateText }}">

                <img class="gallery-thumb"
                     alt="{{- $imageName -}}."
                     loading="{{- cond (gt $index 12) "lazy" "eager" -}}"

                     {{- if eq $image.MediaType.SubType "gif" -}}
                        src="{{- $imageURL -}}"
                     {{- else -}}
                         {{- /* Create resized thumbs and add them into a "t/" subdirectory */ -}}
                         {{- $finalThumb1x := $image.Resize (printf "%dx webp q60" $thumbSize1x) -}}
                         {{- $finalThumb2x := $image.Resize (printf "%dx webp q50" $thumbSize2x) -}}
                         {{- if lt $finalThumb1x.Height $thumbSize1x -}}
                             {{- $finalThumb1x = $image.Resize (printf "x%d webp q60" $thumbSize1x) -}}
                             {{- $finalThumb2x = $image.Resize (printf "x%d webp q50" $thumbSize2x) -}}
                         {{- end -}}

                        {{- $hash := substr (md5 $image.RelPermalink) 0 8 -}}
                        {{- $thumbDir := path.Dir $image.RelPermalink -}}
                            
                         {{- $thumb1x := $finalThumb1x | resources.Copy (print $thumbDir "/t/" $hash ".webp") -}}
                         {{- $thumb2x := $finalThumb2x | resources.Copy (print $thumbDir "/t/" $hash "@2x.webp") -}}

                         src="{{- $thumb1x.RelPermalink | safeURL -}}"
                         srcset="{{- $thumb1x.RelPermalink | safeURL }} 1x,
                                 {{- $thumb2x.RelPermalink | safeURL }} 2x"
                     {{- end -}}>
                
                {{- /* Image Caption, for sizes M and up */ -}}
                {{- if ne $size "s" -}}
                    <br><span>{{- $imageName | replaceRE " - " "&nbsp;&#8209; " | safeHTML -}}</span>
                {{- end -}}
            </a>
        {{- end -}}
    {{- end }}
</div>


{{- /* Gallery Filter JS, for sizes M and up */ -}}
{{- if ne $size "s" -}}
    {{- $galleryFilterJS := resources.Get "js/gallery-filter.js" | resources.Minify -}}
    <script src="{{ print $galleryFilterJS.RelPermalink "?" now.Unix }}" defer></script>
{{- end -}}

{{- /* PhotosSwipe CSS */ -}}
{{- $photoSwipeCSS := (resources.Get "css/photoswipe.css" | resources.Minify).RelPermalink -}}
<link rel="stylesheet" href="{{ $photoSwipeCSS }}">

{{- /* PhotosSwipe JS */ -}}
<script type="module">
    {{ $photoSwipeLightboxJS := (resources.Get "js/photoswipe-lightbox.esm.min.js").RelPermalink -}}
    import PhotoSwipeLightbox from '{{ $photoSwipeLightboxJS }}';

    const lightbox = new PhotoSwipeLightbox({
        {{- $photoSwipeJS := printf "%q" (resources.Get "js/photoswipe.esm.min.js").RelPermalink | safeJS }}
        pswpModule: () => import({{ $photoSwipeJS }}),
        gallery: '.gallery',
        children: 'a',
        showHideAnimationType: 'zoom',
        preload: [1, 4],
        showAnimationDuration: 260,
        hideAnimationDuration: 260,
        easing: "cubic-bezier(0.4, 0, 0.25, 1)",
        closeTitle: '{{ T "close" }}',
        zoomTitle: '{{ T "zoom" }}',
        arrowPrevTitle: '{{ T "previous" }}',
        arrowNextTitle: '{{ T "next" }}',
        errorMsg: '{{ T "psw-error" }}'
    });
    lightbox.init();

    function setLightboxParam(id) {
        try {
            const url = new URL(window.location);
            if (id) {
                url.searchParams.set('lightbox', id);
            } else {
                url.searchParams.delete('lightbox');
            }
            history.replaceState(null, '', url);
        } catch {
        }
    }

    lightbox.on('change', () => {
        try {
            const el = lightbox.pswp.currSlide.data.element;
            if (el && el.id) setLightboxParam(el.id);
        } catch {
        }
    });

    lightbox.on('close', () => {
        try {
            setLightboxParam(null);
        } catch {
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
        try {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('lightbox');
            if (id) {
                const link = document.getElementById(id);
                if (link) {
                    const gallery = link.closest('.gallery');
                    const items = [...gallery.querySelectorAll('a')];
                    const index = items.indexOf(link);
                    if (index >= 0) {
                        lightbox.loadAndOpen(index, {gallery, element: link});
                        return;
                    }
                }
                setLightboxParam(null);
            }
        } catch {
        }
    });

    window.pswpLightbox = lightbox;
</script>
