{{/* Based on https://www.codeproject.com/Articles/5276331/Creating-an-Image-Gallery-with-Hugo-and-Lightbox2 */}}

{{/* Optional parameter to specify an asset subdirectory */}}
{{- $param0 := default "" (.Get 0) -}}
{{- $directory := cond (ne "" $param0) (print "/" $param0) "" -}}
{{- $path := (print "images" $directory "/*.{jpg,JPG,jpeg,JPEG,png,PNG,gif,GIF}") -}}

<!--Use eager loading for the first 20 images-->
<div class="gallery">
	{{- $images := (resources.Match $path) -}}

	<div class="gallery-filter">
		<form action="#" class="gallery-filter-form">
			<input type="search"
				   placeholder="{{ i18n "filter" }}"
				   class="gallery-filter-input"
				   autocomplete="off"
				   autocapitalize="off"
				   autofocus>
				   
			<input type="submit"
				   value="Filter"
				   tabindex="-1"
				   class="gallery-filter-submit">
		</form>
	</div>
	
	{{ with $images }}
	    {{ range $image_index, $image := . }} 
	    	{{ $imageName := ($image.Name | replaceRE "^.*/(.*)\\..*" "$1") | safeHTMLAttr }} 
	    	
	    	<a href="{{ $image.Permalink }}"
	    	   class="gallery-image state-visible"
	    	   data-pswp-width="{{ .Width }}"
	    	   data-pswp-height="{{ .Height }}"
	    	   data-cropped="true"
	    	   target="_blank">
		    	
		    	<img class="gallery-image-thumb"
			    	 alt="{{ $imageName }}"
		    	
					 {{/* Load first 20 images eagerly (above fold on FullHD) */}}
		    		 loading="{{ cond (gt $image_index 20) "lazy" "eager" }}"
		    		 
		    		 {{/* .Resize not supported for GIFs, use the image itself */}}
		    		 {{- if (eq $image.MediaType.SubType "gif") -}}
			    		src="{{ $image.Permalink }}"
		    		 {{- else -}}
		    			{{- $thumb := $image.Resize "288x q75" -}}
			    		src="{{ $thumb.Permalink }}"
		    		 {{- end -}}/>
      		</a>
	    {{ end }}
	{{ end }}
</div>

<link rel="stylesheet" href="/css/photoswipe.css">

<script src="{{ print "/js/gallery_filter.js?" now.Unix }}"></script>
<script type="module">
	import PhotoSwipeLightbox from '/js/photoswipe-lightbox.esm.min.js';
	const lightbox = new PhotoSwipeLightbox({
	  gallery: '.gallery',
	  children: 'a',
	  showHideAnimationType: 'zoom',
	  pswpModule: () => import('/js/photoswipe.esm.min.js'),
	  preload: [1, 4],
	  closeTitle: {{ i18n "close" }},
	  zoomTitle: {{ i18n "zoom" }},
	  arrowPrevTitle: {{ i18n "previous" }},
	  arrowNextTitle: {{ i18n "next" }},
	  errorMsg: {{ i18n "psw-error" }}
	});
	lightbox.init();
</script>
