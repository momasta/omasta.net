{{- /*
    assets/sass/components/_gallery.scss
*/ -}}

{{- /* Based on https://www.codeproject.com/Articles/5276331/Creating-an-Image-Gallery-with-Hugo-and-Lightbox2 */ -}}

{{- /* Optional parameter to specify an asset subdirectory */ -}}
{{- $param0 := default "" (.Get 0) -}}

{{- $directory := cond (ne "" $param0) (print "/" $param0) "" -}}
{{- $path := (print "images" $directory "/*.{jpg,JPG,jpeg,JPEG,png,PNG,gif,GIF}") -}}
{{- $dateFormat := .Site.Params.dateFormat -}}

<div class="gallery-filter">
    <form action="#" class="gallery-filter-form">
        <label for="gallery-search" class="visually-hidden">
            {{- T "search-memes" -}}
        </label>
        <input type="search"
               id="gallery-search"
               name="q"
               placeholder="{{ T "search" }}"
               class="gallery-filter-input"
               autocomplete="on"
               autocapitalize="off"
               autofocus
               title="- {{ T "press-esc" }}
- {{ T "press-stroke" }}"
               aria-label="{{ T "search-memes" }}">

        <input type="submit"
               value="{{ T "searcht" }}"
               class="visually-hidden">
    </form>
</div>


<p id="gallery-no-results" aria-hidden="true" class="state-hidden">
    {{- T "no-images-found" -}}
</p>

<div class="gallery">
    {{- $images := resources.Match $path }}

    {{- if $images }}
        {{- $imgs := slice -}}

        {{- range $idx, $image := $images -}}
            {{- $filePath := printf "assets/%s" $image.Name }}
            {{- $fileInfo := os.Stat $filePath }}
            {{- $imgs = $imgs | append (dict "modTime" $fileInfo.ModTime "image" $image) }}
        {{- end -}}

        {{- $sorted := sort $imgs "modTime" "desc" -}}

        {{- range $index, $item := $sorted -}}
            {{ $image := $item.image }}
            {{ $imageName := ($image.Name | replaceRE "^.*/(.*)\\..*" "$1") | safeHTMLAttr }}
            {{ $imageURL := $image.RelPermalink | safeURL -}}

            <a href="{{ $imageURL }}"
               class="gallery-image"
               data-pswp-width="{{ $image.Width }}"
               data-pswp-height="{{ $image.Height }}"
               data-cropped="true"
               id="{{ $imageName |
                   replaceRE "['â€™~#_+./@]" "" |
                   urlize |
                   replaceRE "-{2,}" "-" -}}"
               target="_blank"
               title="{{- $imageName }}

{{ T "last-mod-short" }} {{ $item.modTime.Format $dateFormat | safeHTML -}}">

                <img class="gallery-thumb"
                     alt="{{ $imageName }}."
                     loading="{{ cond (gt $index 12) "lazy" "eager" -}}"

                     {{- if eq $image.MediaType.SubType "gif" -}}
                     src="{{ $imageURL }}"
                     {{- else -}}

                     {{- $hash := substr (md5 $image.RelPermalink) 0 8 -}}
                         {{- $dir := path.Dir $image.RelPermalink -}}

                         {{- /* Create resized thumbs and copy them into a "t/" subfolder */ -}}
                         {{- $thumb1 := $image.Resize "150x webp q60" |
                             resources.Copy (printf "%s/t/%s.webp" $dir $hash) -}}
                         {{- $thumb2 := $image.Resize "300x webp q50" |
                             resources.Copy (printf "%s/t/%s@2x.webp" $dir $hash) -}}

                         src="{{ $thumb1.RelPermalink | safeURL }}"
                         srcset="{{ $thumb1.RelPermalink | safeURL }} 1x, {{ $thumb2.RelPermalink | safeURL }} 2x"
                     {{- end -}}><br>
                <span>{{- $imageName | replaceRE " - " "&nbsp;&#8209; " | safeHTML -}}</span>
            </a>
        {{- end -}}
    {{- end }}
</div>


{{- /* Gallery Filter */ -}}
{{- $galleryFilterJS := resources.Get "js/gallery-filter.js" | resources.Minify -}}
<script src="{{ print $galleryFilterJS.RelPermalink "?" now.Unix }}" defer></script>

{{- /* PhotosSwipe CSS */ -}}
{{- $photoSwipeCSS := (resources.Get "css/photoswipe.css" | resources.Minify).RelPermalink -}}
<link rel="stylesheet" href="{{ $photoSwipeCSS }}">

{{- /* PhotosSwipe JS */ -}}
<script type="module">
    {{ $photoSwipeLightboxJS := (resources.Get "js/photoswipe-lightbox.esm.min.js").RelPermalink -}}
    import PhotoSwipeLightbox from '{{ $photoSwipeLightboxJS }}';

    const lightbox = new PhotoSwipeLightbox({
        {{- $photoSwipeJS := printf "%q" (resources.Get "js/photoswipe.esm.min.js").RelPermalink | safeJS }}
        pswpModule: () => import({{ $photoSwipeJS }}),
        gallery: '.gallery',
        children: 'a',
        showHideAnimationType: 'zoom',
        preload: [1, 4],
        showAnimationDuration: 260,
        hideAnimationDuration: 260,
        easing: "cubic-bezier(0.4, 0, 0.25, 1)",
        closeTitle: '{{ T "close" }}',
        zoomTitle: '{{ T "zoom" }}',
        arrowPrevTitle: '{{ T "previous" }}',
        arrowNextTitle: '{{ T "next" }}',
        errorMsg: '{{ T "psw-error" }}'
    });
    lightbox.init();

    function setLightboxParam(id) {
        try {
            const url = new URL(window.location);
            if (id) {
                url.searchParams.set('lightbox', id);
            } else {
                url.searchParams.delete('lightbox');
            }
            history.replaceState(null, '', url);
        } catch {
        }
    }

    lightbox.on('change', () => {
        try {
            const el = lightbox.pswp.currSlide.data.element;
            if (el && el.id) setLightboxParam(el.id);
        } catch {
        }
    });

    lightbox.on('close', () => {
        try {
            setLightboxParam(null);
        } catch {
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
        try {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('lightbox');
            if (id) {
                const link = document.getElementById(id);
                if (link) {
                    const gallery = link.closest('.gallery');
                    const items = [...gallery.querySelectorAll('a')];
                    const index = items.indexOf(link);
                    if (index >= 0) {
                        lightbox.loadAndOpen(index, {gallery, element: link});
                        return;
                    }
                }
                setLightboxParam(null);
            }
        } catch {
        }
    });

    window.pswpLightbox = lightbox;
</script>
