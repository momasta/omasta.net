{{/*
    assets/sass/components/_gallery.scss
*/}}

{{/* Based on https://www.codeproject.com/Articles/5276331/Creating-an-Image-Gallery-with-Hugo-and-Lightbox2 */}}

{{/* Optional parameter to specify an asset subdirectory */}}
{{- $param0 := default "" (.Get 0) -}}
{{- $directory := cond (ne "" $param0) (print "/" $param0) "" -}}
{{- $path := (print "images" $directory "/*.{jpg,JPG,jpeg,JPEG,png,PNG,gif,GIF}") -}}

<div class="gallery-filter">
    <form action="#" class="gallery-filter-form">
        <input type="search"
               placeholder="{{ T "filter" }}"
               class="gallery-filter-input"
               autocomplete="on"
               autocapitalize="off"
               autofocus
               title="{{ T "press-esc" }}">

        <input type="submit"
               value="Filter"
               class="gallery-filter-submit">
    </form>
</div>

<p id="gallery-no-results" aria-hidden="true" class="state-hidden">
    {{ T "no-images-found" }}
</p>

<!--Use eager loading for the first 20 images-->
<div class="gallery">
    {{- $images := resources.Match $path }}

    {{- if $images }}
        {{- $imgs := slice }}

        {{- range $idx, $image := $images }}
            {{- $filePath := printf "assets/%s" $image.Name }}
            {{- $fileInfo := os.Stat $filePath }}
            {{- $imgs = $imgs | append (dict "modTime" $fileInfo.ModTime "image" $image) }}
        {{- end }}

        {{- $sorted := sort $imgs "modTime" "desc" }}

        {{- range $index, $item := $sorted }}
            {{- $image := $item.image }}
            {{ $imageName := ($image.Name | replaceRE "^.*/(.*)\\..*" "$1") | safeHTMLAttr }}
            {{ $imageURL := $image.RelPermalink | safeURL }}

            <a href="{{ $imageURL }}"
               class="gallery-image"
               data-pswp-width="{{ $image.Width }}"
               data-pswp-height="{{ $image.Height }}"
               data-cropped="true"
               id="{{ $imageName | humanize | urlize }}"
               title="{{ $imageName }}"
               target="_blank">

                {{ if eq $image.MediaType.SubType "gif" }}
                    <img class="gallery-image-thumb"
                         alt="{{ $imageName }}."
                         loading="{{ cond (gt $index 20) "lazy" "eager" }}"
                         src="{{ $imageURL }}">
                {{ else }}
                    {{- $hash := substr (md5 $image.RelPermalink) 0 8 -}}
                    {{- $dir := path.Dir $image.RelPermalink -}}

                    {{- /* Create resized thumbs and copy them into a "t/" subfolder */ -}}
                    {{- $thumb1 := $image.Resize "150x webp q80" | resources.Copy (printf "%s/t/%s.webp" $dir $hash) -}}
                    {{- $thumb2 := $image.Resize "300x webp q70" | resources.Copy (printf "%s/t/%s@2x.webp" $dir $hash) -}}

                    <img class="gallery-image-thumb"
                         alt="{{ $imageName }}."
                         loading="{{ cond (gt $index 20) "lazy" "eager" }}"
                         src="{{ $thumb1.RelPermalink | safeURL }}"
                         srcset="{{ $thumb1.RelPermalink | safeURL }} 1x, {{ $thumb2.RelPermalink | safeURL }} 2x"
                         sizes="150px">
                {{ end }}
            </a>
        {{- end }}
    {{- end }}
</div>


{{ $photoswipeCSS := resources.Get "css/photoswipe.css" | resources.Minify }}
{{ $photoswipeJS := resources.Get "js/photoswipe.esm.min.js" }}
{{ $photoswipeLightboxJS := resources.Get "js/photoswipe-lightbox.esm.min.js" }}
{{ $galleryFilterJS := resources.Get "js/gallery_filter.js" | resources.Minify }}

<!-- Gallery Filter -->
<script src="{{ print $galleryFilterJS.RelPermalink "?" now.Unix }}"></script>

<!-- Photoswipe -->
<link rel="stylesheet" href="{{ print $photoswipeCSS.RelPermalink "?" now.Unix }}">
<script type="module">
    import PhotoSwipeLightbox from '{{ print $photoswipeLightboxJS.RelPermalink "?" now.Unix | safe.JSStr }}';

    const lightbox = new PhotoSwipeLightbox({
        gallery: '.gallery',
        children: 'a',
        showHideAnimationType: 'zoom',
        pswpModule: () => import('{{ print $photoswipeJS.RelPermalink "?" now.Unix | safe.JSStr }}'),
        preload: [1, 4],
        closeTitle: '{{ T "close" }}',
        zoomTitle: '{{ T "zoom" }}',
        arrowPrevTitle: '{{ T "previous" }}',
        arrowNextTitle: '{{ T "next" }}',
        errorMsg: '{{ T "psw-error" }}'
    });
    lightbox.init();

    window.pswpLightbox = lightbox;
</script>
