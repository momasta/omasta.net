<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default "en-gb" }}" class="theme-light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Site Information -->
    <title>
        {{- if not .IsHome -}} {{ if .Page.Title }}{{ .Page.Title }} - {{ end }} {{- end -}}
        {{- if hugo.IsServer -}} Hugo {{- else -}} {{- .Site.Title -}} {{- end -}}
    </title>

    {{ with .Site.Params.description }}
        <meta name="description" content="{{ . }}"> {{ end }}
    {{ with .Site.Params.author }}
        <meta name="author" content="{{ . }}"> {{ end }}
    {{ if .Keywords }}
        {{ with .Keywords }}
            <meta name="keywords"
                  content="{{ range $i, $e := . }}{{ if $i }}, {{ end }}{{ $e }}{{ end }}">
        {{ end }}
    {{ end }}

    <!-- Perform before rendering page -->
    <script>
        const html = document.documentElement;
        const hasLocalStorage = localStorage.getItem('theme');

        if (hasLocalStorage === 'theme-light') {
            html.classList.add('theme-light');
        } else {
            html.classList.add('theme-dark');
            localStorage.setItem('theme', 'theme-dark');
        }
    </script>

    <!-- Critical CSS -->
    <style>
        :root {
            color-scheme: dark light;
        }

        body:not(.loaded) * {
            transition: none !important;
        }

        html.theme-dark {
            background-color: #000;
            color: #fdfdfd;
        }

        html.theme-dark .card {
            background-color: #222;
        }

        html.theme-light .toggle-theme-light,
        html.theme-dark .toggle-theme-dark {
            display: none;
        }

        html {
            font: normal 100% / 1.4 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, sans-serif;
        }

        h1 {
            margin: 0;
        }

        .logo img {
            width: 45px;
            height: 64px;
        }

        .card {
            padding: 24px 20px;
            margin: 8px 0;
        }
    </style>

    <!-- Stylesheet -->
    {{ $main_options := (dict "targetPath" "css/site.css" "outputStyle" "compressed") }}
    {{ $main_template := resources.Get "sass/main.scss" }}
    {{ $main_style := $main_template | resources.ExecuteAsTemplate "main_parsed.scss" . | toCSS $main_options | resources.Minify }}
    <link rel="stylesheet" href="{{ print $main_style.RelPermalink "?" now.Unix }}">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" href="{{ .Site.Home.Permalink }}posts/index.xml"
          title="{{ .Site.Title }} - {{ T "posts" }}" hreflang="{{ .Lang }}">

    <!-- Shortcut Icons -->
    <link rel="icon" href="/images/favicon.jpg" sizes="32x32">
    <link rel="shortcut icon" href="/images/favicon.jpg" type="image/x-icon">
    <link rel="icon" href="/images/favicon-192.jpg">
    <link rel="apple-touch-icon-precomposed" href="/images/favicon-180.jpg">

    <!-- Apple-Specific Meta Tags -->
    <meta name="theme-color" content="#b8b8b8" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="format-detection" content="telephone=no">

    <!-- OG Tags -->
    {{ template "_internal/opengraph.html" . }}
</head>

<body{{ with .Type }} class="{{ . }}" {{ end }} ondragstart="return false;" ondrop="return false;" draggable="false">

<!-- Critical JS, dark mode handling, integral part -->
<script>
    window.addEventListener('load', () => document.body.classList.add('loaded'));

    // From https://codepen.io/MrGrigri/details/XQmWBv, modified

    const themeColorLight = '#b8b8b8';
    const themeColorDark = '#000000';

    const themePreference = () => {
        let supports = false;
        let theme = undefined;

        if (hasLocalStorage === 'theme-light') {
            theme = 'theme-light';
        } else if (hasLocalStorage === 'theme-dark') {
            theme = 'theme-dark';
        }

        if (window.matchMedia(`(prefers-color-scheme: dark)`).matches) {
            theme = hasLocalStorage || 'theme-dark';
            supports = true;
        }

        if (window.matchMedia(`(prefers-color-scheme: light)`).matches) {
            theme = hasLocalStorage || 'theme-light';
            supports = true;
        }

        return {supports, theme};
    }


    document.addEventListener('DOMContentLoaded', e => {
        const userThemePreference = themePreference();
        const toggleThemeLight = document.querySelector('.toggle-theme-light');
        const toggleThemeDark = document.querySelector('.toggle-theme-dark');
        const metaThemeColor = document.querySelectorAll('meta[name="theme-color"]');

        const setThemeDark = () => {
            html.classList.add('theme-dark');
            html.classList.remove('theme-light');

            metaThemeColor.forEach(function (tag) {
                tag.setAttribute('content', themeColorDark);
            });
        }

        const setThemeLight = () => {
            html.classList.remove('theme-dark');
            html.classList.add('theme-light');

            metaThemeColor.forEach(function (tag) {
                tag.setAttribute('content', themeColorLight);
            });
        }

        const setTheme = () => {
            if (userThemePreference.theme === 'theme-light') {
                setThemeLight();
            } else {
                setThemeDark();
            }
        }

        setTheme();

        toggleThemeDark.addEventListener('click', e => {
            setThemeDark();
            localStorage.setItem('theme', 'theme-dark');
        }, false);

        toggleThemeLight.addEventListener('click', e => {
            setThemeLight();
            localStorage.setItem('theme', 'theme-light');
        }, false);
    }, false);
</script>

<div id="content">
    {{ block "main" . }}{{ end }}
    {{ partial "footer" . }}
</div>

{{ $copyHeadingLinkJS := resources.Get "js/copy-heading-link.js" | resources.Minify }}
<script src="{{ print $copyHeadingLinkJS.RelPermalink "?" now.Unix }}"></script>
</body>
</html>
