<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default "en-gb" }}">

<head>
	<meta charset="UTF-8">
	
	<!-- Perform this before rendering page to prevent white flashes -->
	<script>
		const html = document.documentElement;
		const hasLocalStorage = localStorage.getItem('theme');
		
		if (hasLocalStorage === 'theme-dark') {
			html.classList.add('theme-dark');
		}
	</script>
	
	<!-- Basic styling for dark theme, will be overridden by CSS -->
	<style>
		html.theme-dark {
			background-color: #000;
		}
		
		html.theme-dark .card {
			background-color: #222;
		}
		
		a:visited {
			color: inherit;
		}
	</style>
	
	<meta name="viewport" content="width=device-width, initial-scale=1">

	{{/* todo Use Hugo-native properties for OG tags */}}
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta property="og:title" content="Marek Omasta">
	<meta property="og:type" content="website">
	<meta property="og:description" content="My personal website">
	<meta property="og:image" content="https://marek.omasta.net/images/profile-picture-og-2.jpg">
	<meta property="og:url" content="https://marek.omasta.net/">

	{{/* todo Use Hugo-native properties for icons */}}
	<link rel="icon" href="/images/favicon.jpg" sizes="32x32">
	<link rel="shortcut icon" href="/images/favicon.jpg" type="image/x-icon">
	<link rel="icon" href="/images/favicon-192.jpg">
	<link rel="apple-touch-icon-precomposed" href="/images/favicon-180.jpg">

	<title>{{ if .IsHome }}{{ else }}{{ if .Page.Title }}{{ .Page.Title }} - {{ end }}{{ end }}{{ .Site.Title }}</title>
	{{ with .Site.Params.description }}<meta name="description" content="{{ . }}">{{ end }}
	{{ with .Site.Params.author }}<meta name="author" content="{{ . }}">{{ end }}
	{{ with .OutputFormats.Get "RSS" -}}
		{{ printf `<link rel="%s" type="%s" href="%s" title="%s">` .Rel .MediaType.Type .RelPermalink $.Site.Title | safeHTML }}
	{{- end }}
	{{ if .Keywords }}
  		{{ with .Keywords }}
  			<meta name="keywords" content="{{ range $i, $e := . }}{{ if $i }}, {{ end }}{{ $e }}{{ end }}">
  		{{ end }}
    {{ end }}

	{{ $main_options := (dict "targetPath" "css/site.css" "outputStyle" "compressed") }}
	{{ $main_template := resources.Get "sass/main.scss" }}
	{{ $main_style := $main_template | resources.ExecuteAsTemplate "main_parsed.scss" . | toCSS $main_options | resources.Minify }}
	<link rel="stylesheet" href="{{ print $main_style.RelPermalink "?" now.Unix }}">
</head>

<body{{ with .Type }} class="{{ . }}" {{ end }} ondragstart="return false;" ondrop="return false;" draggable="false">
	<div id="content">
		{{ block "main" . }}{{ end }}
		{{ partial "footer" . }}
	</div>
	
	{{/* Dark mode handling, integral part, don't move to a file */}}
	<script>
		// From https://codepen.io/MrGrigri/details/XQmWBv, modified
		
		const themePreference = () => {
			let supports = false;
			let theme = undefined;
			
			if (hasLocalStorage === 'theme-light') {
				theme = 'theme-light';
			} else if (hasLocalStorage === 'theme-dark') {
				theme = 'theme-dark';
			}

			if (window.matchMedia(`(prefers-color-scheme: dark)`).matches) {
				theme = hasLocalStorage ? hasLocalStorage : 'theme-dark';
				supports = true;
			};
			
			if (window.matchMedia(`(prefers-color-scheme: light)`).matches) {
				theme = hasLocalStorage ? hasLocalStorage : 'theme-light';
				supports = true;
			};
			
			if (window.matchMedia(`(prefers-color-scheme: no-preference)`).matches) {
				theme = hasLocalStorage ? hasLocalStorage : 'none';
				supports = true;
			};
			
			return {supports, theme};
		}


		document.addEventListener('DOMContentLoaded', e => {			
			const userThemePreference = themePreference();
			const toggleThemeLight = document.querySelector('.toggle-theme-light');
			const toggleThemeDark = document.querySelector('.toggle-theme-dark');
				
			const setTheme = () => {
				switch(userThemePreference.theme) {
				case 'theme-dark':
					html.classList.add('theme-dark');
					html.classList.remove('theme-light');
					break;
				case 'theme-light':
					html.classList.remove('theme-dark');
					html.classList.add('theme-light');
					break;
				}
			}
			
			setTheme();
			
			toggleThemeDark.addEventListener('click', e => {
		        e.preventDefault();
				html.classList.add('theme-dark');
				html.classList.remove('theme-light');
				localStorage.setItem('theme', 'theme-dark');
			}, false);
				
			toggleThemeLight.addEventListener('click', e => {
				e.preventDefault();
				html.classList.remove('theme-dark');
				html.classList.add('theme-light');
				localStorage.setItem('theme', 'theme-light');
			}, false);
		}, false);
	</script>
</body>
</html>
