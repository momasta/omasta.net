<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default "en-gb" }}" class="theme-light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Site Information -->
    <title>
        {{- if not .IsHome -}} {{ if .Page.Title }}{{ .Page.Title }} - {{ end }} {{- end -}}
        {{- if hugo.IsServer -}} Hugo {{- else -}} {{- .Site.Title -}} {{- end -}}
    </title>

    {{ with .Site.Params.description }}
        <meta name="description" content="{{ . }}"> {{ end }}
    {{ with .Site.Params.author }}
        <meta name="author" content="{{ . }}"> {{ end }}
    {{ if .Keywords }}
        {{ with .Keywords }}
            <meta name="keywords"
                  content="{{ range $i, $e := . }}{{ if $i }}, {{ end }}{{ $e }}{{ end }}">
        {{ end }}
    {{ end }}

    <!-- Perform before rendering page -->
    <script>
        const html = document.documentElement;
        const hasLocalStorage = localStorage.getItem('theme');

        if (hasLocalStorage === 'theme-light') {
            html.classList.add('theme-light');
        } else if (hasLocalStorage === 'theme-dark') {
            html.classList.add('theme-dark');
        } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
            html.classList.add('theme-light');
        } else {
            html.classList.add('theme-dark');
        }
    </script>

    <!-- Critical CSS -->
    <style>
        :root {
            color-scheme: dark light;
        }

        body:not(.loaded) * {
            transition: none !important;
        }

        html.theme-dark {
            background-color: #000;
            color: #fdfdfd;
        }

        html.theme-dark svg {
            fill: #b8b8b8;
        }

        html.theme-dark .card {
            background-color: #222;
        }

        html.theme-light .toggle-theme-light,
        html.theme-dark .toggle-theme-dark {
            display: none;
        }

        html {
            font: normal 100% / 1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
        }

        h1 {
            margin: 0;
        }

        .logo img {
            width: 45px;
            height: 64px;
        }

        .card {
            padding: 24px 20px;
            margin: 8px 0;
        }
    </style>

    <!-- Stylesheet -->
    {{ $main_options := (dict "targetPath" "css/site.css" "outputStyle" "compressed") }}
    {{ $main_template := resources.Get "sass/main.scss" }}
    {{ $main_style := $main_template | resources.ExecuteAsTemplate "main_parsed.scss" . | toCSS $main_options | resources.Minify }}
    <link rel="stylesheet" href="{{ print $main_style.RelPermalink "?" now.Unix }}">

    {{ if hugo.IsMultilingual }}

        <!-- RSS alternates -->
        {{ with .Site.GetPage "section" "posts" }}
            {{ range .AllTranslations }}
                {{ $lang := .Language.LanguageCode }}
                {{ with .OutputFormats.Get "RSS" }}
                    <link rel="alternate"
                          type="application/rss+xml"
                          hreflang="{{ $lang }}"
                          href="{{ .Permalink | safeURL }}"/>
                {{ end }}
            {{ end }}
            <!-- x-default -->
            {{ with .OutputFormats.Get "RSS" }}
                <link rel="alternate"
                      type="application/rss+xml"
                      hreflang="x-default"
                      href="{{ .Permalink | safeURL }}"/>
            {{ end }}
        {{ end }}

        <!-- HTML alternates -->
        {{ $current := . }}
        <link rel="alternate"
              hreflang="{{ .Language.LanguageCode }}"
              href="{{ .Permalink | safeURL }}"/>
        {{ range .Translations }}
            <link rel="alternate"
                  hreflang="{{ .Language.LanguageCode }}"
                  href="{{ .Permalink | safeURL }}"/>
        {{ end }}
        <link rel="alternate"
              hreflang="x-default"
              href="{{ $current.Permalink | safeURL }}"/>

    {{ else }}

        <!-- Single-language site: just the plain RSS feed, no hreflang -->
        {{ with .Site.GetPage "section" "posts" }}
            {{ with .OutputFormats.Get "RSS" }}
                <link rel="alternate"
                      type="application/rss+xml"
                      href="{{ .Permalink | safeURL }}"/>
            {{ end }}
        {{ end }}

    {{ end }}

    <!-- Shortcut Icons -->
    <link rel="icon" href="/images/favicon.jpg" sizes="32x32">
    <link rel="shortcut icon" href="/images/favicon.jpg" type="image/x-icon">
    <link rel="icon" href="/images/favicon-192.jpg">
    <link rel="apple-touch-icon-precomposed" href="/images/favicon-180.jpg">

    <!-- Apple-Specific Meta Tags -->
    <meta name="theme-color" content="#b8b8b8" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="format-detection" content="telephone=no">

    <!-- OG Tags -->
    {{ template "_internal/opengraph.html" . }}
</head>

<body{{ with .Type }} class="{{ . }}" {{ end }} ondragstart="return false;" ondrop="return false;" draggable="false">

<!-- Critical JS, dark mode handling, integral part -->
<script>
    window.addEventListener('load', () => document.body.classList.add('loaded'));

    const themeColorLight = '#b8b8b8';
    const themeColorDark = '#000000';

    const themePreference = () => {
        const stored = localStorage.getItem('theme');
        if (stored) return stored;
        if (window.matchMedia('(prefers-color-scheme: light)').matches) return 'theme-light';
        return 'theme-dark';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const toggleThemeLight = document.querySelector('.toggle-theme-light');
        const toggleThemeDark = document.querySelector('.toggle-theme-dark');
        const metaThemeColor = document.querySelectorAll('meta[name="theme-color"]');
        const html = document.documentElement;

        const setThemeDark = () => {
            html.classList.add('theme-dark');
            html.classList.remove('theme-light');
            metaThemeColor.forEach(tag => tag.setAttribute('content', themeColorDark));
        }

        const setThemeLight = () => {
            html.classList.remove('theme-dark');
            html.classList.add('theme-light');
            metaThemeColor.forEach(tag => tag.setAttribute('content', themeColorLight));
        }

        const applyTheme = () => {
            const pref = themePreference();
            if (pref === 'theme-light') setThemeLight();
            else setThemeDark();
        }

        // Initial theme
        applyTheme();

        // Listen for system preference changes, but only if no override is set
        const mediaDark = window.matchMedia('(prefers-color-scheme: dark)');
        const mediaLight = window.matchMedia('(prefers-color-scheme: light)');

        const systemChangeHandler = () => {
            if (!localStorage.getItem('theme')) {
                applyTheme();
            }
        };

        mediaDark.addEventListener('change', systemChangeHandler);
        mediaLight.addEventListener('change', systemChangeHandler);

        // Manual toggles
        toggleThemeDark.addEventListener('click', () => {
            setThemeDark();
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                localStorage.removeItem('theme'); // Back to auto
            } else {
                localStorage.setItem('theme', 'theme-dark');
            }
        }, false);

        toggleThemeLight.addEventListener('click', () => {
            setThemeLight();
            if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                localStorage.removeItem('theme'); // Back to auto
            } else {
                localStorage.setItem('theme', 'theme-light');
            }
        }, false);
    }, false);
</script>

<div id="content">
    {{ block "main" . }}{{ end }}
    {{ partial "footer" . }}
</div>

{{ $copyHeadingLinkJS := resources.Get "js/copy-heading-link.js" | resources.Minify }}
<script src="{{ print $copyHeadingLinkJS.RelPermalink "?" now.Unix }}"></script>
</body>
</html>
